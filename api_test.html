<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RMS API Connectivity Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .profile-selector {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
        }
        .profile-selector label {
            font-weight: bold;
            margin-right: 10px;
        }
        .profile-selector select {
            padding: 5px;
            margin-right: 10px;
        }
        .endpoint-list {
            list-style: none;
            padding: 0;
        }
        .endpoint-list li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .endpoint-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ RMS API Connectivity Test</h1>
        <p>This page tests the connectivity to all RMS API endpoints to help diagnose polling issues.</p>
        
        <div class="profile-selector">
            <label for="profileSelect">Profile:</label>
            <select id="profileSelect">
                <option value="default">default</option>
                <option value="1">dashboard1</option>
                <option value="2">dashboard2</option>
                <option value="3">dashboard3</option>
            </select>
            <button onclick="updateProfile()">Update Profile</button>
            <span id="currentProfile">Current: default</span>
        </div>

        <div class="test-section">
            <h3>üîç Quick Tests</h3>
            <button onclick="testHealth()">Test Health Endpoint</button>
            <button onclick="testBasicConnectivity()">Test Basic Connectivity</button>
            <button onclick="testAllEndpoints()">Test All Endpoints</button>
            <button onclick="clearResults()">Clear Results</button>
            <div id="quickResults"></div>
        </div>

        <div class="test-section">
            <h3>üåê Individual Endpoint Tests</h3>
            <ul class="endpoint-list">
                <li>
                    <strong>Health Check:</strong> 
                    <button onclick="testEndpoint('health')">Test</button>
                    <span id="health-status">Not tested</span>
                </li>
                <li>
                    <strong>Current Video:</strong> 
                    <button onclick="testEndpoint('get_current_video')">Test</button>
                    <span id="current-video-status">Not tested</span>
                </li>
                <li>
                    <strong>Playback State:</strong> 
                    <button onclick="testEndpoint('get_playback_state')">Test</button>
                    <span id="playback-state-status">Not tested</span>
                </li>
                <li>
                    <strong>Volume:</strong> 
                    <button onclick="testEndpoint('get_volume')">Test</button>
                    <span id="volume-status">Not tested</span>
                </li>
                <li>
                    <strong>Mute State:</strong> 
                    <button onclick="testEndpoint('get_mute_state')">Test</button>
                    <span id="mute-status">Not tested</span>
                </li>
                <li>
                    <strong>Loop Mode:</strong> 
                    <button onclick="testEndpoint('get_loop_mode')">Test</button>
                    <span id="loop-status">Not tested</span>
                </li>
                <li>
                    <strong>Play All Mode:</strong> 
                    <button onclick="testEndpoint('get_play_all_mode')">Test</button>
                    <span id="play-all-status">Not tested</span>
                </li>
                <li>
                    <strong>External Audio Mode:</strong> 
                    <button onclick="testEndpoint('get_external_audio_mode')">Test</button>
                    <span id="external-audio-status">Not tested</span>
                </li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>üîß Manual Testing</h3>
            <p>Test a specific endpoint manually:</p>
            <input type="text" id="manualEndpoint" placeholder="action=health" style="width: 200px; padding: 5px;">
            <button onclick="testManualEndpoint()">Test</button>
            <div id="manualResults"></div>
        </div>
    </div>

    <script>
        let currentProfile = 'default';
        let testResults = [];

        function updateProfile() {
            const select = document.getElementById('profileSelect');
            currentProfile = select.value;
            document.getElementById('currentProfile').textContent = `Current: ${currentProfile}`;
            console.log('Profile updated to:', currentProfile);
        }

        function getProfileQuery() {
            if (currentProfile === 'default') {
                return 'profile=default';
            } else {
                return `d=${currentProfile}`;
            }
        }

        function addResult(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const result = {
                timestamp,
                message,
                type
            };
            testResults.push(result);
            displayResults();
        }

        function displayResults() {
            const container = document.getElementById('testResults');
            container.innerHTML = testResults.map(result => 
                `<div class="result ${result.type}">[${result.timestamp}] ${result.message}</div>`
            ).join('');
        }

        function clearResults() {
            testResults = [];
            displayResults();
            // Reset all status indicators
            const statusElements = document.querySelectorAll('[id$="-status"]');
            statusElements.forEach(el => el.textContent = 'Not tested');
        }

        async function testEndpoint(action) {
            // Fix the status element ID generation
            let statusElementId;
            switch(action) {
                case 'health':
                    statusElementId = 'health-status';
                    break;
                case 'get_current_video':
                    statusElementId = 'current-video-status';
                    break;
                case 'get_playback_state':
                    statusElementId = 'playback-state-status';
                    break;
                case 'get_volume':
                    statusElementId = 'volume-status';
                    break;
                case 'get_mute_state':
                    statusElementId = 'mute-status';
                    break;
                case 'get_loop_mode':
                    statusElementId = 'loop-status';
                    break;
                case 'get_play_all_mode':
                    statusElementId = 'play-all-status';
                    break;
                case 'get_external_audio_mode':
                    statusElementId = 'external-audio-status';
                    break;
                default:
                    statusElementId = 'health-status'; // fallback
            }
            
            const statusElement = document.getElementById(statusElementId);
            if (!statusElement) {
                console.error('Status element not found for action:', action, 'ID:', statusElementId);
                addResult(`Error: Status element not found for ${action}`, 'error');
                return;
            }
            
            statusElement.textContent = 'Testing...';
            
            try {
                const profileQuery = getProfileQuery();
                const url = `api.php?action=${action}&${profileQuery}`;
                
                addResult(`Testing ${action}...`, 'loading');
                
                const response = await fetch(url, {
                    method: 'GET',
                    signal: AbortSignal.timeout(10000) // 10 second timeout
                });
                
                if (response.ok) {
                    const data = await response.json();
                    statusElement.textContent = `‚úÖ OK (${response.status})`;
                    addResult(`${action}: ‚úÖ Success - Status: ${response.status}, Data: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    statusElement.textContent = `‚ùå Error (${response.status})`;
                    addResult(`${action}: ‚ùå HTTP Error - Status: ${response.status}`, 'error');
                }
            } catch (error) {
                statusElement.textContent = `‚ùå Failed`;
                addResult(`${action}: ‚ùå Network Error - ${error.message}`, 'error');
            }
        }

        async function testHealth() {
            try {
                addResult('Testing health endpoint...', 'loading');
                const response = await fetch('api.php?action=health', {
                    signal: AbortSignal.timeout(10000)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`Health: ‚úÖ Success - Status: ${response.status}, Data: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    addResult(`Health: ‚ùå HTTP Error - Status: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult(`Health: ‚ùå Network Error - ${error.message}`, 'error');
            }
        }

        async function testBasicConnectivity() {
            addResult('Testing basic connectivity...', 'loading');
            
            try {
                // Test if we can reach the server at all
                const response = await fetch('api.php', {
                    signal: AbortSignal.timeout(5000)
                });
                
                addResult(`Basic connectivity: ‚úÖ Server reachable - Status: ${response.status}`, 'success');
            } catch (error) {
                addResult(`Basic connectivity: ‚ùå Server unreachable - ${error.message}`, 'error');
            }
        }

        async function testAllEndpoints() {
            addResult('Starting comprehensive endpoint test...', 'info');
            
            const endpoints = [
                'health',
                'get_current_video',
                'get_playback_state',
                'get_volume',
                'get_mute_state',
                'get_loop_mode',
                'get_play_all_mode',
                'get_external_audio_mode'
            ];
            
            for (const endpoint of endpoints) {
                await testEndpoint(endpoint);
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            addResult('Comprehensive endpoint test completed!', 'info');
        }

        async function testManualEndpoint() {
            const input = document.getElementById('manualEndpoint');
            const endpoint = input.value.trim();
            
            if (!endpoint) {
                addResult('Please enter an endpoint to test', 'error');
                return;
            }
            
            try {
                addResult(`Testing manual endpoint: ${endpoint}`, 'loading');
                
                const profileQuery = getProfileQuery();
                const url = `api.php?${endpoint}&${profileQuery}`;
                
                const response = await fetch(url, {
                    signal: AbortSignal.timeout(10000)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`Manual test: ‚úÖ Success - Status: ${response.status}, Data: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    addResult(`Manual test: ‚ùå HTTP Error - Status: ${response.status}`, 'error');
                }
            } catch (error) {
                addResult(`Manual test: ‚ùå Network Error - ${error.message}`, 'error');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addResult('API Test Page loaded successfully', 'success');
            addResult(`Current profile: ${currentProfile}`, 'info');
        });
    </script>
</body>
</html>
